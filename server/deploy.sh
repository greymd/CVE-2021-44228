#!/usr/bin/env bash
set -eu
DEFAULT_TAG="$(git log -1 --pretty=format:%h)"
readonly THIS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
TAG="${1:-$DEFAULT_TAG}"
rm -rf "$THIS_DIR"/build
docker build -t cve-2021-44228-server .
docker tag cve-2021-44228-server ghcr.io/greymd/cve-2021-44228/server:latest
docker tag cve-2021-44228-server ghcr.io/greymd/cve-2021-44228/server:"$TAG"
docker push ghcr.io/greymd/cve-2021-44228/server:latest
docker push ghcr.io/greymd/cve-2021-44228/server:"$TAG"
